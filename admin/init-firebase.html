<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initialiser Firebase - LIQUIDO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="max-w-2xl w-full bg-slate-800 rounded-2xl p-8 shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">Initialisation Firebase</h1>
            <p class="text-slate-400">Charger les donn√©es du catalogue dans Firebase Realtime Database</p>
        </div>

        <div id="status" class="mb-6 p-4 rounded-lg bg-slate-700/50 hidden">
            <p id="status-text" class="text-sm"></p>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-2 text-slate-300">Donn√©es √† charger</label>
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <p class="text-sm text-slate-400">
                        <span class="material-symbols-outlined text-primary align-middle text-lg">info</span>
                        <span class="ml-2">2 sections, 9 marques, 20+ lignes/produits</span>
                    </p>
                </div>
            </div>

            <button id="init-btn"
                class="w-full bg-primary hover:bg-primary/90 text-black font-bold py-4 px-6 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined">cloud_upload</span>
                <span>Initialiser Firebase avec les donn√©es</span>
            </button>

            <div id="progress" class="hidden">
                <div class="bg-slate-700 rounded-full h-2 mb-2">
                    <div id="progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300"
                        style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-slate-400 text-center"></p>
            </div>

            <div id="result" class="hidden mt-6 p-4 rounded-lg"></div>
        </div>

        <div class="mt-8 pt-6 border-t border-slate-700">
            <p class="text-xs text-slate-500 text-center">
                ‚ö†Ô∏è Cette op√©ration remplacera toutes les donn√©es existantes dans Firebase
            </p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script src="../src/js/services/firebase-config.js"></script>

    <script>
        // Wait for Firebase to be loaded
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                if (typeof firebase !== 'undefined' && window.firebaseConfig) {
                    resolve();
                } else {
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (typeof firebase !== 'undefined' && window.firebaseConfig) {
                            clearInterval(checkInterval);
                            resolve();
                        } else if (attempts > 50) {
                            clearInterval(checkInterval);
                            reject(new Error('Firebase SDK n\'a pas pu √™tre charg√©. Veuillez recharger la page.'));
                        }
                    }, 100);
                }
            });
        }
    </script>

    <script>
        const catalogData = {
            "catalog": {
                "sections": [
                    {
                        "id": "cat_liquidi",
                        "name": "Liquidi",
                        "description": "E-liquides et ar√¥mes",
                        "brands": [
                            {
                                "name": "Suprem-e",
                                "type": "liquid",
                                "website": "https://suprem-e.com/",
                                "logo_url": "/images/brands/suprem-e_logo.png",
                                "lines": [
                                    { "name": "FIRST PICK RE-BRAND", "image_url": "/images/products/suprem-e/re-brand.jpg", "products": [] },
                                    { "name": "FLAVOURBAR", "image_url": "/images/products/suprem-e/flavourbar.jpg", "products": [] },
                                    { "name": "FIZZ", "image_url": "/images/products/suprem-e/fizz.jpg", "products": [] },
                                    { "name": "BOMB", "image_url": "/images/products/suprem-e/bomb.jpg", "products": [] },
                                    { "name": "ONE", "image_url": "/images/products/suprem-e/one.jpg", "products": [] },
                                    { "name": "AND FLAVOURS", "image_url": "/images/products/suprem-e/and.jpg", "products": [] }
                                ]
                            },
                            {
                                "name": "Vaporart",
                                "type": "liquid",
                                "website": "https://www.vaporart.it/",
                                "logo_url": "/images/brands/vaporart_logo.png",
                                "lines": [
                                    { "name": "SUPER FLAVOR", "image_url": "/images/products/vaporart/super-flavor.jpg", "products": [] },
                                    { "name": "SEVEN WONDERS", "image_url": "/images/products/vaporart/seven-wonders.jpg", "products": [] },
                                    { "name": "ENJOYSVAPO", "image_url": "/images/products/vaporart/enjoysvapo.jpg", "products": [] },
                                    { "name": "VAPORART", "image_url": "/images/products/vaporart/vaporart.jpg", "products": [] },
                                    { "name": "VAPORICE", "image_url": "/images/products/vaporart/vaporice.jpg", "products": [] }
                                ]
                            },
                            {
                                "name": "Goldwave",
                                "type": "liquid",
                                "website": "goldwave.it/",
                                "logo_url": "/images/brands/goldwave_logo.png",
                                "lines": [
                                    { "name": "DUBAI CHOCOLATE", "products": [] },
                                    { "name": "CREAMY SELECTION", "products": [] },
                                    { "name": "FRESH SELECTION", "products": [] },
                                    { "name": "PREMIUM SELECTION", "products": [] },
                                    { "name": "TABACCO MIXOLOGY", "products": [] }
                                ]
                            },
                            {
                                "name": "Elfbar",
                                "type": "liquid",
                                "website": "https://www.elfbar.it/",
                                "logo_url": "/images/brands/elfbar_logo.png",
                                "lines": [
                                    { "name": "ELFLIQ", "image_url": "/images/products/elfbar/elfliq.jpg", "products": [] }
                                ]
                            },
                            {
                                "name": "Kiwi",
                                "type": "liquid",
                                "website": "kiwivapor.com/it/",
                                "logo_url": "/images/brands/kiwi_logo.png",
                                "lines": []
                            }
                        ]
                    },
                    {
                        "id": "cat_dispositivi",
                        "name": "Dispositivi",
                        "description": "Cigarettes √©lectroniques et mat√©riel",
                        "brands": [
                            {
                                "name": "Geekvape",
                                "type": "device",
                                "website": "geekvape.com/",
                                "logo_url": "/images/brands/geekvape_logo.png",
                                "products": [
                                    { "name": "PEAK 2" },
                                    { "name": "SONDER Q" },
                                    { "name": "WENAX M" },
                                    { "name": "WENAX M1" },
                                    { "name": "WENAX M2" }
                                ]
                            },
                            {
                                "name": "Vaporesso",
                                "type": "device",
                                "website": "vaporesso.com",
                                "logo_url": "/images/brands/vaporesso_logo.png",
                                "products": [
                                    { "name": "ECO ONE PRO" },
                                    { "name": "LUXE XR MAX" },
                                    { "name": "VECO GO" }
                                ]
                            },
                            {
                                "name": "Kiwi",
                                "type": "device",
                                "website": "kiwivapor.com/it/",
                                "logo_url": "/images/brands/kiwi_logo.png",
                                "products": [
                                    { "name": "KIWI SPARK" },
                                    { "name": "KIWI GO+" }
                                ]
                            },
                            {
                                "name": "Elfbar",
                                "type": "device",
                                "website": "https://www.elfbar.it/",
                                "logo_url": "/images/brands/elfbar_logo.png",
                                "products": [
                                    { "name": "ELFA" }
                                ]
                            }
                        ]
                    }
                ]
            }
        };

        const initBtn = document.getElementById('init-btn');
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const progressDiv = document.getElementById('progress');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resultDiv = document.getElementById('result');

        function showStatus(message, type = 'info') {
            statusDiv.classList.remove('hidden');
            statusText.textContent = message;
            statusDiv.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' :
                type === 'error' ? 'bg-red-500/20 text-red-400 border border-red-500/30' :
                    'bg-blue-500/20 text-blue-400 border border-blue-500/30'
                }`;
        }

        function updateProgress(percent, text) {
            progressDiv.classList.remove('hidden');
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
        }

        initBtn.addEventListener('click', async () => {
            if (!confirm('‚ö†Ô∏è Cette op√©ration va remplacer toutes les donn√©es existantes dans Firebase. Continuer ?')) {
                return;
            }

            initBtn.disabled = true;
            initBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span><span>Initialisation en cours...</span>';
            resultDiv.classList.add('hidden');
            showStatus('Chargement de Firebase...', 'info');

            try {
                // Wait for Firebase SDK to be loaded
                await waitForFirebase();

                showStatus('Connexion √† Firebase...', 'info');

                // Initialize Firebase
                const { initializeFirebase } = window.firebaseConfig;
                const { database } = await initializeFirebase();

                updateProgress(20, 'Connexion √©tablie');
                showStatus('Connexion √©tablie, envoi des donn√©es...', 'info');

                // Save to Firebase
                const catalogRef = database.ref('catalog');

                updateProgress(50, 'Envoi des donn√©es...');

                // Save the catalog content directly (not the wrapper)
                console.log('üì§ Saving catalog to Firebase:', catalogData.catalog);
                await catalogRef.set(catalogData.catalog);

                updateProgress(100, 'Termin√© !');
                showStatus('‚úÖ Donn√©es initialis√©es avec succ√®s dans Firebase !', 'success');

                resultDiv.classList.remove('hidden');
                resultDiv.className = 'mt-6 p-4 rounded-lg bg-emerald-500/20 border border-emerald-500/30';

                // Count statistics from the new structure
                const sections = catalogData.catalog.sections;
                const totalBrands = sections.reduce((sum, s) => sum + s.brands.length, 0);
                const totalLines = sections.reduce((sum, s) =>
                    sum + s.brands.reduce((bSum, b) => bSum + (b.lines?.length || 0), 0), 0);
                const totalProducts = sections.reduce((sum, s) =>
                    sum + s.brands.reduce((bSum, b) => bSum + (b.products?.length || 0), 0), 0);

                resultDiv.innerHTML = `
                    <h3 class="font-bold text-emerald-400 mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        Initialisation r√©ussie
                    </h3>
                    <div class="text-sm text-slate-300 space-y-1 mt-3">
                        <p>‚úì ${sections.length} sections cr√©√©es</p>
                        <p>‚úì ${totalBrands} marques cr√©√©es</p>
                        <p>‚úì ${totalLines} lignes de produits cr√©√©es</p>
                        <p>‚úì ${totalProducts} produits cr√©√©s</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-emerald-500/20">
                        <a href="brands/index.html" class="text-emerald-400 hover:text-emerald-300 text-sm font-medium flex items-center gap-1">
                            <span>Voir les marques</span>
                            <span class="material-symbols-outlined text-sm">arrow_forward</span>
                        </a>
                    </div>
                `;

                initBtn.disabled = false;
                initBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span>Initialisation termin√©e</span>';

            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Erreur lors de l\'initialisation: ' + error.message, 'error');

                resultDiv.classList.remove('hidden');
                resultDiv.className = 'mt-6 p-4 rounded-lg bg-red-500/20 border border-red-500/30';
                resultDiv.innerHTML = `
                    <h3 class="font-bold text-red-400 mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined">error</span>
                        Erreur
                    </h3>
                    <p class="text-sm text-slate-300 mt-2">${error.message}</p>
                    <p class="text-xs text-slate-400 mt-2">V√©rifiez la console pour plus de d√©tails.</p>
                `;

                initBtn.disabled = false;
                initBtn.innerHTML = '<span class="material-symbols-outlined">cloud_upload</span><span>R√©essayer</span>';
            }
        });
    </script>
</body>

</html>